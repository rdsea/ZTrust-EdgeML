####################################
#    MongoDB
####################################
sudo apt-get install gnupg curl

curl -fsSL https://www.mongodb.org/static/pgp/server-8.0.asc |
  sudo gpg -o /usr/share/keyrings/mongodb-server-8.0.gpg \
    --dearmor

echo "deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-8.0.gpg ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/8.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-8.0.list

sudo apt-get update

sudo apt-get install -y mongodb-org

sudo systemctl start mongod

sudo systemctl daemon-reload

sudo systemctl enable mongod

####################################
#    add /etc/hosts
####################################
# Example using Terraform template vars
ZITI_EDGE_CONTROLLER_IP="${ziti_edge_controller_ip}"
ZITI_EDGE_ROUTER_IP="${ziti_edge_router_ip}"

echo "$ZITI_EDGE_CONTROLLER_IP ctrl.cloud.hong3nguyen.com" | sudo tee -a /etc/hosts
echo "$ZITI_EDGE_ROUTER_IP router.cloud.hong3nguyen.com" | sudo tee -a /etc/hosts

####################################
#    Install ziti-edge-tunnel
####################################
curl -sSLf https://get.openziti.io/tun/package-repos.gpg |
  gpg --dearmor --output /usr/share/keyrings/openziti.gpg

chmod -c +r /usr/share/keyrings/openziti.gpg

echo "deb [signed-by=/usr/share/keyrings/openziti.gpg] https://packages.openziti.org/zitipax-openziti-deb-stable jammy main" |
  tee /etc/apt/sources.list.d/openziti.list >/dev/null

apt update

apt install -y ziti-edge-tunnel

####################################
#    Install ziti-edge login
####################################
apt install curl gpg -y

if ! command -v ziti &>/dev/null; then
  echo "'ziti' CLI not found — installing..."
  curl -sS https://get.openziti.io/install.bash | sudo bash -s openziti-router
else
  echo "'ziti' CLI is already installed — skipping installation."
fi

# ----------- Set variables -----------
export ZITI_HOME="/opt/openziti"
export ZITI_CTRL_ADVERTISED_ADDRESS="ctrl.cloud.hong3nguyen.com"
export ZITI_CTRL_ADVERTISED_PORT="1280"
export ZITI_USER="admin"
export ZITI_PWD="admin"
export ZITI_BOOTSTRAP_CONFIG_ARGS=""
export ZITI_ROUTER_ADVERTISED_ADDRESS="router.cloud.hong3nguyen.com"

# -----------Generate edge router token and config (not enrolled yet) -----------
$ZITI_HOME/bin/ziti edge login https://$ZITI_CTRL_ADVERTISED_ADDRESS:$ZITI_CTRL_ADVERTISED_PORT --yes -u $ZITI_USER -p $ZITI_PWD

ziti edge create identity "database-$(cat /etc/hostname)" \
  --jwt-output-file /tmp/database.jwt --role-attributes database

ziti edge enroll --jwt /tmp/database.jwt --out /tmp/database.json

# ziti-edge-tunnel run -i /tmp/database.json
nohup ziti-edge-tunnel run -i /tmp/database.json >/var/log/ziti-edge-tunnel.log 2>&1 &
