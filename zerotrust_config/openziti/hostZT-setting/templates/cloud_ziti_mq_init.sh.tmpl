#!/bin/bash

set -euo pipefail

# ==============================================================================
# FUNCTIONS
# ==============================================================================

# Source the common functions
# shellcheck source=common.sh.tmpl
# source "../scripts/common.sh"


# --- Log a message ---
log() {
  echo ">>> $(date '+%Y-%m-%d %H:%M:%S') - $1"
}

set_ziti_variables() {
  log "Setting Ziti environment variables"
  export ZITI_HOME="{{ ziti_config.ctrl.cloud_ctrl.home }}"
  export ZITI_CTRL_ADVERTISED_ADDRESS="{{ ziti_config.ctrl.cloud_ctrl.ctrl_advertised_address }}"
  export ZITI_CTRL_ADVERTISED_PORT="{{ ziti_config.ctrl.cloud_ctrl.ctrl_advertised_port }}"
  export ZITI_USER="{{ ziti_config.ctrl.cloud_ctrl.user }}"
  export ZITI_PWD="{{ ziti_config.ctrl.cloud_ctrl.password }}"
  export ZITI_DIR="/home/{{ ssh_user }}"
}

# --- Install Ziti CLI ---
install_ziti_cli() {
  apt install curl gpg -y
  log "Installing Ziti CLI"
  if ! command -v ziti &>/dev/null; then
    source /etc/os-release
    curl -sS https://get.openziti.io/install.bash | sudo bash -s openziti-router
    log "Ziti CLI installed."
  else
    log "Ziti CLI is already installed."

  fi
}

# --- Install Ziti Edge Tunnel ---
install_ziti_edge_tunnel() {
  log "Installing Ziti Edge Tunnel"
  if ! command -v ziti-edge-tunnel &>/dev/null; then
    curl -sSLf https://get.openziti.io/tun/package-repos.gpg |
    gpg --dearmor --output /usr/share/keyrings/openziti.gpg

    chmod -c +r /usr/share/keyrings/openziti.gpg

    echo "deb [signed-by=/usr/share/keyrings/openziti.gpg] https://packages.openziti.org/zitipax-openziti-deb-stable jammy main" |
      tee /etc/apt/sources.list.d/openziti.list >/dev/null

    apt update

    apt install -y ziti-edge-tunnel
    log "Ziti Edge Tunnel installed."
  else
    log "Ziti Edge Tunnel is already installed."
  fi

}

# --- Add Ziti DNS entries to /etc/hosts ---
add_ziti_dns_entries() {
  log "Adding Ziti DNS entries to /etc/hosts"
  local cloud_ip="$1"
  #local edge_ip="$2"
  
  # Ensure the entries are not already present
  if ! grep -q "{{  ziti_config.ctrl.cloud_ctrl.ctrl_advertised_address  }}" /etc/hosts; then
    echo "$cloud_ip {{  ziti_config.ctrl.cloud_ctrl.ctrl_advertised_address  }}" | sudo tee -a /etc/hosts
    echo "$cloud_ip {{  ziti_config.ctrl.cloud_ctrl.router.cloud_router_advertised_address  }}" | sudo tee -a /etc/hosts
  fi
  {% for edge in ziti_config.router.edge_router %}
  if ! grep -q "{{  edge.edge_router_advertised_address }}" /etc/hosts; then
    echo "{{ edge.edge_router_ip }} {{ edge.edge_router_advertised_address }}" | sudo tee -a /etc/hosts
  fi
  {% endfor %}
}

# --- Create and enroll a Ziti identity ---
create_and_enroll_identity() {
  local identity_name="$1"
  local identity_roles="$2"
  local jwt_file="/home/{{ ssh_user }}/$1.jwt"
  local json_file="/home/{{ ssh_user }}/$1.json"

  log "Creating and enrolling identity: $1"
  
  export ZITI_HOME="{{ ziti_config.ctrl.cloud_ctrl.home }}"

  $ZITI_HOME/bin/ziti edge login https://{{ ziti_config.ctrl.cloud_ctrl.ctrl_advertised_address }}:{{ ziti_config.ctrl.cloud_ctrl.ctrl_advertised_port }} --yes -u {{ ziti_config.ctrl.cloud_ctrl.user }} -p {{ ziti_config.ctrl.cloud_ctrl.password }}
  
  $ZITI_HOME/bin/ziti edge create identity device $identity_name -a $identity_roles --jwt-output-file $jwt_file
  
  $ZITI_HOME/bin/ziti edge enroll --jwt $jwt_file --out $json_file
  
  echo $json_file
}


install_rabbitmq() {
  log "Installing RabbitMQ"
  apt-get update -y
  apt-get install -y curl gnupg apt-transport-https

  # Add RabbitMQ signing keys
  curl -1sLf "https://keys.openpgp.org/vks/v1/by-fingerprint/0A9AF2115F4687BD29803A206B73A36E6026DFCA" | gpg --dearmor > /usr/share/keyrings/com.rabbitmq.team.gpg
  curl -1sLf https://github.com/rabbitmq/signing-keys/releases/download/3.0/cloudsmith.rabbitmq-erlang.E495BB49CC4BBE5B.key | gpg --dearmor > /usr/share/keyrings/rabbitmq.E495BB49CC4BBE5B.gpg
  curl -1sLf https://github.com/rabbitmq/signing-keys/releases/download/3.0/cloudsmith.rabbitmq-server.9F4587F226208342.key | gpg --dearmor > /usr/share/keyrings/rabbitmq.9F4587F226208342.gpg

  # Add RabbitMQ apt repositories
  tee /etc/apt/sources.list.d/rabbitmq.list <<EOF
deb [arch=amd64 signed-by=/usr/share/keyrings/rabbitmq.E495BB49CC4BBE5B.gpg] https://ppa1.rabbitmq.com/rabbitmq/rabbitmq-erlang/deb/ubuntu jammy main
deb [arch=amd64 signed-by=/usr/share/keyrings/rabbitmq.9F4587F226208342.gpg] https://ppa1.rabbitmq.com/rabbitmq/rabbitmq-server/deb/ubuntu jammy main
EOF

  # Install Erlang and RabbitMQ
  apt-get update -y
  apt-get install -y erlang-base erlang-crypto erlang-inets erlang-mnesia erlang-os-mon erlang-public-key erlang-runtime-tools erlang-ssl erlang-syntax-tools erlang-tools rabbitmq-server --fix-missing
}

# --- Configure RabbitMQ ---
configure_rabbitmq() {
  log "Configuring RabbitMQ"
  mkdir -p /etc/rabbitmq

  tee /etc/rabbitmq/rabbitmq.conf >/dev/null <<EOF
listeners.tcp.default = 0.0.0.0:5672
management.listener.port = 15672
EOF

  tee /etc/rabbitmq/rabbitmq-env.conf >/dev/null <<EOF
RABBITMQ_NODE_PORT=5672
RABBITMQ_NODENAME=rabbitmq@localhost
EOF

  systemctl restart rabbitmq-server
}



# ==============================================================================
# MAIN EXECUTION
# ==============================================================================

main() {
  set_ziti_variables
  install_rabbitmq
  configure_rabbitmq
  add_ziti_dns_entries "${controller_ip}"
  install_ziti_edge_tunnel
  setup_application

  # Create and enroll the Ziti identity
  json_file=$(create_and_enroll_identity "message-queue" "message-queue,{{ ziti_config.ctrl.cloud_ctrl.router.cloud_router_attribute }}")

  # Run the tunnel in the background
  nohup ziti-edge-tunnel run -i "{{ dir_default }}/$1.json" >/var/log/ziti-edge-tunnel.log 2>&1 &

  log "Message Queue setup complete."
}

main "$@"
