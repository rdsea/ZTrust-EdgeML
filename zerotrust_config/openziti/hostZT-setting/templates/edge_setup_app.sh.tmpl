#!/bin/bash

set -euo pipefail

# ==============================================================================
# VARIABLES
# ==============================================================================

# Passed as environment variables from the calling script
export CLOUD_IP="$CLOUD_IP"
export EDGE_IP="$EDGE_IP"

# Ziti configuration from variable_input.yml
ZITI_HOME="{{ ziti_config.home }}"
ZITI_CTRL_ADVERTISED_ADDRESS="{{ ziti_config.ctrl_advertised_address }}"
ZITI_CTRL_ADVERTISED_PORT="{{ ziti_config.ctrl_advertised_port }}"
ZITI_USER="{{ ziti_config.user }}"
ZITI_PWD="{{ ziti_config.password }}"
ZITI_CLOUD_ROUTER_ADVERTISED_ADDRESS="{{ ziti_config.router_advertised_address }}"
ZITI_EDGE_ROUTER_ADVERTISED_ADDRESS="{{ ziti_config.edge_router_advertised_address }}"

CURRENT_DIR="$(pwd)/{{ssh_user}}"

# ==============================================================================
# FUNCTIONS
# ==============================================================================

# --- Helper function for logging ---
log() {
  echo "--- $1 ---"
}

# --- Install Ziti CLI ---
install_ziti_cli() {
  log "Installing Ziti CLI"
  if ! command -v ziti &>/dev/null; then
    curl -sS https://get.openziti.io/install.bash | bash -s openziti-router
  else
    log "'ziti' CLI is already installed â€” skipping installation."
  fi
}

# --- Add DNS entries for Ziti controllers/routers ---
add_dns_entries() {
  log "Adding Ziti DNS entries to /etc/hosts"
  echo "$CLOUD_IP {{ ziti_config.ctrl_advertised_address }}" >>/etc/hosts
  echo "$CLOUD_IP {{ ziti_config.router_advertised_address }}" >>/etc/hosts
  {% if ziti_config.edge_router_enabled %}
  echo "$EDGE_IP {{ ziti_config.edge_router_advertised_address }}" >>/etc/hosts
  {% endif %}
}

# --- Prepare Docker Compose file ---
prepare_docker_compose() {
  log "Preparing Docker Compose file"
  # Ensure envsubst is available
  apt-get update -y && apt-get install -y gettext-base

  # Pass JAEGER_IP from the calling script (script_settup_sensor_edge.sh)
  export JAEGER_IP="$(cd ../cloud-gcp && terraform output -raw database_ip)"

  envsubst <"${CURRENT_DIR}/docker-compose.template.yml" >"${CURRENT_DIR}/docker-compose.yml"
  docker compose -f "${CURRENT_DIR}/docker-compose.yml" down --volumes || true
}

# --- Create and enroll Ziti identities ---
create_and_enroll_ziti_identities() {
  log "Creating and enrolling Ziti identities"
  "${ZITI_HOME}/bin/ziti" edge login "https://${ZITI_CTRL_ADVERTISED_ADDRESS}:${ZITI_CTRL_ADVERTISED_PORT}" --yes --username "${ZITI_USER}" --password "${ZITI_PWD}"

  rm -rf /tmp/*.json /tmp/*.jwt

  # Execute the templated create_id_entities.sh script
  "${CURRENT_DIR}/create_id_entities.sh"
}

# --- Start Docker Compose services ---
start_docker_compose_services() {
  log "Starting Docker Compose services"
  docker compose -f "${CURRENT_DIR}/docker-compose.yml" up -d
}

# ==============================================================================
# MAIN EXECUTION
# ==============================================================================

main() {
  log "Starting Edge Application Setup"
  install_ziti_cli
  add_dns_entries
  prepare_docker_compose
  create_and_enroll_ziti_identities
  start_docker_compose_services
  log "Edge Application Setup Complete."
}

main "$@"
