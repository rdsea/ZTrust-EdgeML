#!/bin/bash

set -euo pipefail

source "$(dirname "$0")/../scripts/common.sh"

main(){

ansible-playbook k3s.orchestration.site -i edge/k3s_inventory.local.yml

ssh aaltosea@{{ k3s_cluster.ctrl[0] }} "sudo cat /etc/rancher/k3s/k3s.yaml" > ~/.kube/config

CILIUM_CLI_VERSION=$(curl -s https://raw.githubusercontent.com/cilium/cilium-cli/main/stable.txt)
CLI_ARCH=amd64
if [ "$(uname -m)" = "aarch64" ]; then CLI_ARCH=arm64; fi
curl -L --fail --remote-name-all https://github.com/cilium/cilium-cli/releases/download/${CILIUM_CLI_VERSION}/cilium-linux-${CLI_ARCH}.tar.gz{,.sha256sum}
sha256sum --check cilium-linux-${CLI_ARCH}.tar.gz.sha256sum
sudo tar xzvfC cilium-linux-${CLI_ARCH}.tar.gz /usr/local/bin
rm cilium-linux-${CLI_ARCH}.tar.gz{,.sha256sum}
cilium install --version 1.18.0

# setup dns for all nodes go to ctrl.cloud.hong3nguyen.com

kubectl -n kube-system get configmap coredns -o yaml > coredns-config.yaml

kubectl -n kube-system edit configmap coredns


# config Install MetalLB (bare metal solution)
kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.13.10/config/manifests/metallb-native.yaml

kubectl get pods -n metallb-system

kubectl apply -f k3s_metallb.local.yml

}

main"$@"
