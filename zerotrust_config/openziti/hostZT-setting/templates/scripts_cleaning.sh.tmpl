#!/bin/bash

set -euo pipefail

# ==============================================================================
# FUNCTIONS
# ==============================================================================

# --- Helper function for logging ---
log() {
  echo "--- $1 ---"
}

# --- Remove Ziti DNS entries from /etc/hosts ---
clean_hosts_file() {
  log "Removing OpenZiti DNS entries from /etc/hosts"
  sed -i "/{{ ziti_config.ctrl.cloud_ctrl.ctrl_advertised_address }}/d" /etc/hosts
  sed -i "/{{ ziti_config.ctrl.cloud_ctrl.router.cloud_router_advertised_address }}/d" /etc/hosts
  {% for edge_ in ziti_config.router.edge_router %} 
  sed -i "/{{ edge_.edge_router_advertised_address }}/d" /etc/hosts{% endfor %}
}

# --- Clean up Ziti Router service ---
clean_ziti_router_service() {
  log "Cleaning Ziti Router service"
  SERVICE="ziti-router.service"

  if systemctl list-unit-files | grep -q "^$SERVICE"; then
    log "$SERVICE unit file exists."
    if systemctl is-active "$SERVICE"; then
      log "$SERVICE is running. Disabling, stopping, and cleaning it..."
      sudo systemctl disable --now "$SERVICE"
      sudo systemctl reset-failed "$SERVICE" || true
      sudo systemctl clean --what=state "$SERVICE" || true
      sudo apt-get purge -y openziti-router
      sudo apt autoremove -y
      log "Done: $SERVICE has been disabled, reset, and cleaned."
    else
      log "$SERVICE is NOT running. Skipping disable and purge."
    fi
  else
    log "Service unit file $SERVICE does not exist. Nothing to do."
  fi
}

# --- Kill running ziti-edge-tunnel processes ---
kill_ziti_edge_tunnel() {
  log "Shutting down running ziti-edge-tunnel processes"
  if pgrep -f ziti-edge-tunnel >/dev/null; then
    log "ziti-edge-tunnel is running. Killing it now..."
    pkill -f ziti-edge-tunnel
    log "ziti-edge-tunnel has been killed."
  else
    log "ziti-edge-tunnel is NOT running. Nothing to do."
  fi
}

# ==============================================================================
# MAIN EXECUTION
# ==============================================================================

main() {
  clean_hosts_file
  clean_ziti_router_service
  kill_ziti_edge_tunnel
  log "Cleaning script finished."
}

main "$@"
