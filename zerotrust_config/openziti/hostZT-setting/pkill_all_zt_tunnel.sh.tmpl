#!/bin/bash

set -euo pipefail

# ==============================================================================
# VARIABLES
# ==============================================================================

EDGE_SSH_USER="{{ edge_deployment.ssh_user }}"
EDGE_SSH_PASS="{{ edge_deployment.ssh_pass }}"

EDGE_ROUTER_IP="{{ edge_deployment.edge_router_ip }}"
EDGE_APP_IP="{{ edge_deployment.edge_app_ip }}"

# ==============================================================================
# FUNCTIONS
# ==============================================================================

# --- Helper function for logging ---
log() {
  echo "--- $1 ---"
}

# --- Function to kill ziti-edge-tunnel on a remote host ---
kill_remote_ziti_tunnel() {
  local target_ip="$1"
  local ssh_user="$2"
  local ssh_pass="$3"

  log "Attempting to kill ziti-edge-tunnel on $target_ip"

  ssh "$ssh_user@$target_ip" \
    "echo '$ssh_pass' | sudo -S bash -c '\
      echo \"Shutdown running ziti-edge-tunnel\" && \
      if pgrep -f ziti-edge-tunnel >/dev/null; then \
        echo \"ziti-edge-tunnel is running. Killing it now...\" && \
        sudo pkill -f ziti-edge-tunnel && \
        echo \"ziti-edge-tunnel has been killed.\" \
      else \
        echo \"ziti-edge-tunnel is NOT running. Nothing to do.\" \
      fi\
    "
}

# ==============================================================================
# MAIN EXECUTION
# ==============================================================================

main() {
  log "Killing ziti-edge-tunnel processes on all edge machines"

  # Kill on Edge Router
  kill_remote_ziti_tunnel "$EDGE_ROUTER_IP" "$EDGE_SSH_USER" "$EDGE_SSH_PASS"

  # Kill on Edge App
  kill_remote_ziti_tunnel "$EDGE_APP_IP" "$EDGE_SSH_USER" "$EDGE_SSH_PASS"

  # Kill on Sensors
  {% for sensor in edge_deployment.sensors %}
  kill_remote_ziti_tunnel "{{ sensor.ip }}" "$EDGE_SSH_USER" "{{ sensor.ssh_pass }}"
  {% endfor %}

  log "Finished attempting to kill ziti-edge-tunnel processes."
}

main "$@"
